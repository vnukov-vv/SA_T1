# Задание №7
> Постановка задачи на разработку

Взять любой спроектированный метод из ДЗ №3 (не GET, не DELETE)
Описать бизнес – задачу на разработку с проектированием нового метода API (по шаблону)

<sup>*</sup> *вставить диаграмму последовательности и SQL-скрипт*

-----
<details><summary> <i> см. выбранный метод в OpenAPI (Swagger) (развернуть)</i> </summary>

```swagger
openapi: 3.0.0
info:
  title: Bank API
  description: метод API для открытия банковского счета клиенту
  version: 1.0.0
  contact:
    name: Bank API Support
    url: https://www.bank.com/support
    email: support@bank.com
servers:
  - url: https://webinarOpenSchool.org/api/v1
tags:
  - name: Счета

# Методы

## Счета
paths:  

  /accounts:
     post:
      deprecated: false
      tags:
        - Счета
      summary: Создать банковский счет
      description: Открытие в АБС Банка счета Клиенту (юридическому, физическому лицу или индивидуальному предпринимателю), заведенному в Систему.
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                clientId:
                  type: string
                  description: Уникальный идентификатор клиента
                  example: "0001010"
      # Клиента не расписываем т.к. для юрлица и физлица разные атрибуты, остальные параметры транзитивно связаны, поэтому достаточно указать клиента, балансовый счет второго порядка и валюту.
                bals:
                  type: string
                  description: Балансовый счет
                  example: "40817"
                currency:
                  type: string
                  description: Балансовый счет
                  example: "RUB"
                accountName:
                  type: string
                  description: Наименование счета
                  example: "не заполнено"
      responses:
        '201':
          description: Создано
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
        '400':
          description: Некорректный запрос
        '401':
          description: Не авторизован
        '403':
          description: Доступ запрещен
        '409':
          description: Конфликт
        '422':
          description: Проверьте введенные данные
        '500':
          description: Сервер недоступен
          
# Схемы

components:
  schemas:
    Account:
      type: object
      description: Данные счета
      properties:
        accountId:
          type: string
          description: Уникальный идентификатор счета
          example: "00000001234"
        accountName:
        # потому что счета могут быть внутрибанковскими (доходы, расходы и т.д.)
          type: string
          description: Наименование счета
          example: "не заполнено"
        clientId:
          type: string
          description: Уникальный идентификатор клиента
          example: "0001010"
        clientName:
          type: string
          description: Уникальный идентификатор клиента
          example: "Иванов Петр Сидорович"
          # Прочие атрибуты Клиента не расписываем
          # т.к. для юрлица и физлица они разные
        bals:
          type: string
          description: Балансовый счет
          example: "40817"
        currency:
          type: string
          description: Балансовый счет
          example: "RUB"
        accountNumber:
          type: string
          description: Номер счета
          example: "40817810300000000003"
        accountType:
          type: string
          description: Тип счета
          example: "П"
          enum:
           - А
           - П
        status:
          type: string
          description: Статус счета 
          example: "ACTIVE"
          enum:
            - ACTIVE
            - CLOSED
            - RESERVED
            - DELETED
        balance:
          type: number
          format: money
          description: Текущий баланс счета
          example: 0.01
        timeStamp:
          description: Дата модификации
          type: string
          format: date-time
      required:
        - clientId
        - bals
        - currency
```
</details>

<table width="1000" border="1">
<thead>
  <tr>
    <td rowspan="3"><img width="300px" src="https://github.com/user-attachments/assets/9d985eaa-c3fc-4ab3-b84c-4acbd7c1bbb2"></td>
    <td colspan="2" width="700"><p align="center"><b> API. Открытие счета в АБС Банка </b></p></td>
  </tr>
  <tr>
    <td>Дата</td>
    <td>25.08.2024</td>
  </tr>
  <tr>
    <td>Версия</td>
    <td>1.0</td>
  </tr>
</thead>
</table>

<details><summary> <i> см. Шаблон (развернуть)</i> </summary>

# Я как клиент банка хочу увидеть информацию о счете

## История версий
|Задача|Тип изменения|Цвет изменения|Дата|Автор|
|-|-|-|-|-|
|Ссылка на задачу|Создано|-|01.08.2024|Герасимова Е|
|Ссылка на задачу|Изменено (указать раздел и пункт)|синий|10.08.2024|Герасимова Е|

## Бизнес-анализ
[Ссылка на бизнес-анализ](#)

## Назначение и цель
Отображение клиенту информации по запрашиваемому счету

## Предварительные действия
- Реализована модель данных в СУБД
![image](https://github.com/user-attachments/assets/493c53f7-d036-409a-a5f5-ab32c9227022)


- Пользователь прошел аутентификацию и авторизацию

## Ограничения по ролям
- Доступ к интерфейсу возможен для авторизованного клиента с ролью `CLIENT_ALL`

## Макеты
[Ссылка на Figma/Pixco/draw.io](#)

## Основной сценарий (успешный сценарий)

1. Пользователь переходит на страницу `https://....` в свой личный кабинет.
2. Front делает запрос на Back `GET /accounts` ([ссылка на API](#)).
   - Если Back вернул ошибки 4xx, 5xx см. альтернативный сценарий 1.
3. Front отображает список счетов в соответствии с п. [Макеты](#макеты).
4. Пользователь выбирает любой из счетов.
5. Front делает запрос на Back `GET /accounts/{accountId}` ([ссылка на API](#)).
   - Если Back вернул ошибки 4xx, 5xx см. альтернативный сценарий 1.
6. Front отображает детальную информацию по счету в соответствии с п. [Макеты](#макеты).

## Альтернативный сценарий
1. Front отображает ошибку от Back.

## Требования к интерфейсу

|Название<br>атрибута|Тип|Длина|Редактируемость|Маска<br>ввода/отображения|Обязательность|Сортировка|Значение<br>по умолчанию| Источник<br>данных|Примечания|
|-|-|-|-|-|-|-|-|-|-|
|Номер счета|Label|20|-|-|+|-|-|Back|Пример: 40781000208102500000|
|Текущий баланс счета|Label|15,2|-|-|+|-|0.00 Р|Back|-|
|Статус счета|Label|20|-|-|+|-|-|Back|<font color="green">ACTIVE</font> - Активен<br><font color="grey">CLOSED</font> - Закрыт<br><font color="orange">RESERVED</font> - Зарезервирован|

## Результат

- Клиент в ЛК видит информацию о конкретном счете.

---

# `GET /accounts/{accountId}` Получить информацию о банковском счете

## История версий
|Задача|Тип изменения|Цвет изменения|Дата|Автор|
|-|-|-|-|-|
|Ссылка на задачу|Создано|-|10.06.2024|Герасимова Е|

## Сервис 
**Микросервис:** account-number

### Алгоритм вызова
- Sequence UML (вставить картинку)

Акторы:
- Пользователь
- Фронт
- Бек
- БД
- + Альтернативные сценарии

### Свойства вызова

|Свойство|Описание|
|-|-|
|Тип взаимодействия|REST/Kafka/Артемис MQ/gRPC/GraphQL|
|Формат запроса/ответа|JSON/XML|
|Тип вызова| Синхронный/Асинхронный|
|Протокол взаимодействия|HTTPS/MTLS|
|Способ аутентификации|Bearer Token/ API key/ JWT|

### Формат запроса

|Параметр|Тип|Длина|Расположение<br>(path/query)|Обязательность|Описание|
|-|-|-|-|-|-|
|accountId|string|-|path|+|Уникальный идентификатор счета|

#### Пример
*GET /accounts/40781000287777000002*

### Тело запроса
|Параметр|Тип|Длина|Расположение (body)|Обязательность|Описание|Место для сохранения|
|-|-|-|-|-|-|-|
|-|-|-|-|-|-|Таблица.поле|

#### Пример

### Формат ответа

|Параметр|Тип|Длина|Обязательность|Описание|Источник данных|Отображение на фронте|
|-|-|-|-|-|-|-|
|accountId|integer|20|+|Уникальный идентификатор счета|account_info.id|-|
|accountNumber|string|20|+|Номер счета|account_info.number|Номер счета|
|balance|number($double)|15,2|+|Текущий баланс счета|account_info.balance|Баланс счета|
|status<br>|string|20|+|Статус счета<br>Enum:[ACTIVE, CLOSED, RESERVED]|account_info.status|Статус|

#### Пример

```json
{
  "accountId": 70203333,
  "accountNumber": "40781000208102500000",
  "balance": 471230.77,
  "status": "ACTIVE"
}
```
## Коды ответов

|Код|Название|Описание|Поведение системы|
|-|-|-|-|
|200|OK|Запрос обработан|Продолжить процесс|
|400|Bad Request| Некорректный счет|Отобразить ошибку|
|403|Forbidden| Доступ запрещен|Отобразить ошибку|
|404|Not Found| Счет не найден|Отобразить ошибку|
|500|Internal Server Error|Внутренняя ошибка сервера|Отобразить ошибку|

## Алгоритм обработки запроса

1. **Back** при получении запроса, обращается в таблицу `user`, находит список счетов и проводит валидацию на совпадение.
   - (Приложить пример SQL запроса)
2. **Back** по запрошенному счету, обращается в таблицу `account_info` и отдает ответ на **Front** в соответствии с п. [Формат ответа](#формат-ответа).

## Альтернативные процессы

- Ошибки 4xx, 5xx:
  - **Back** возвращает ошибку с текстом на **Front** в соответствии с п. [Коды ответов](#коды-ответов).

------------------------------------------------------------------------------------------------------
</details>

# User Story
Я как Клиент хочу открыть счёт в Банке, чтобы начать им пользоваться

## История версий
|Задача|Тип изменения|Цвет изменения|Дата|Автор|
|-|-|-|-|-|
|[Ссылка на задачу](https://online.stepup.study/course_sessions/3501/tasks/2464/take?return_url=/viewer/sessions/3501/tasks/2464)|Создано|-|28.08.2024|Внуков В.В.|

## Бизнес-анализ

**AS_IS**: Открытие Счета производится при личной явке Клиента в Отделение Банка 

**TO_BE**: Открытие Счета к выбранному продукту производится через удаленные каналы обслуживания

- Повышение качества обслуживания Клиентов в дистанционных каналах
- Сокращение сроков открытия Счета в АБС Банка 
- Открытие Счета в АБС Банка без участия сотрудников
- Переиспользование в омниканальных платформах

Необходимо создание функциональности для дистанционного открытия Клиенту банковского счета в АБС Банка через API, что также позволит снизить операционные издержки.

## Назначение и цель
Целью проекта является реализация функциональности дистанционного открытия cчета Клиента в АБС Банка с использованием API

## Предварительные действия
- Реализована модель данных в СУБД



<details><summary> <i> Код DBML</i> </summary>

```dbml
/* ACCOUNTS - Счета */

// База данных предназначена для управления счетами в АБС Банка в удаленных каналах.

// Описание таблицы ACC
Table acc as acc [note: 'Счет']{
  accountId bigint [primary key, unique, note: 'Первичный ключ.(12)']	
  accountName nvarchar [null, note: 'Наименование Счета.(50)']
  clientId bigint [not null, note: 'ID Клиента.(9)']
  clientName nvarchar [not null, note: 'ID Клиента.(50)']
  bals smallint [not null, note: 'Балансовый Счет.(5)']
  cur smallint [not null, note: 'Балансовый Счет.(5)']
  S bigint [not null, note: 'Номер счета.(20)']
  type nvarchar [not null, note: 'Тип Счета А/П.(1)']
  status nvarchar [not null, note: 'Статус Счета А/П.(20)']
  edited timeStamp [not null, note: 'Дата модификации']
}

// Описание таблицы CLIENTS
Table clients as cli [note: 'Клиенты Банка'] {
  сlientId bigint [primary key, unique, note: 'Уникальный идентификатор в АБС.(8)']
  clientName nvarchar [not null, note: 'ФИО или Наименование (255)']  
}

// Описание таблицы BALS
Table bals as bals [note: 'Балансовый Счет'] {
  bal smallint [not null, note: 'Балансовый Счет.(5)'] 
  name nvarchar [not null, note: 'Описание.(50)']  
}

// Описание таблицы CUR
Table cur as cur [note: 'Валюты'] {
  id nvarchar [primary key, unique, note: 'Цифровой код (3)'] 
  code nvarchar [note: 'Буквенный код.(3)']
  name nvarchar [not null, note: 'Наименование Валюты.(50)']  
}

// Описание таблицы STATUSES
Table statuses as stat [note: 'Статусы'] {
  id smallint [primary key, increment, note: 'Первичный ключ.(2)'] 
  name nvarchar [note: 'Наименование Статуса.(20)']
  ext nvarchar [note: 'Описание Статуса.(50)']
}

// Описание Внешних Ключей

Ref:acc.bals > bals.bal
Ref: acc.clientId > cli.сlientId
Ref: acc.clientName > cli.clientName
Ref: acc.cur > cur.code
Ref: acc.status > stat.id

```
</details>

- Пользователь прошел аутентификацию и авторизацию

## Ограничения по ролям
- Доступ к интерфейсу возможен для авторизованного пользователя с ролью `CLIENT_ALL`

## Макеты
Не требуются.
- Дизайн элементов интерфейса для осуществления целевого действия и отображения уведомления о результатах запроса разрабатывается продуктовыми командами самостоятельно с учетом требований гайда дизайн-кода Банка.
- Отображение результатов запроса Клиенту может производиться как полностью, так и в сокращённом виде.

## Основной сценарий (успешный сценарий)

1. Пользователь находится в личном кабинете соответствующей платформы.
2. После выбора банковского продукта совершает целевое действие
2. Front делает запрос на Back `POST/accounts` ([ссылка на API](#)).
   - Если Back вернул ошибки 4xx, 5xx см. альтернативный сценарий 1.
3. Front отображает список счетов в соответствии с п. [Макеты](#макеты).
4. Пользователь выбирает любой из счетов.
5. Front делает запрос на Back `GET /accounts/{accountId}` ([ссылка на API](#)).
   - Если Back вернул ошибки 4xx, 5xx см. альтернативный сценарий 1.
6. Front отображает детальную информацию по счету в соответствии с п. [Макеты](#макеты).

## Альтернативный сценарий
1. Front отображает ошибку от Back.

## Требования к интерфейсу

|Название<br>атрибута|Тип|Длина|Редактируемость|Маска<br>ввода/отображения|Обязательность|Сортировка|Значение<br>по умолчанию| Источник<br>данных|Примечания|
|-|-|-|-|-|-|-|-|-|-|
|Номер счета|Label|20|-|-|+|-|-|Back|Пример: 40781000208102500000|
|Текущий баланс счета|Label|15,2|-|-|+|-|0.00 Р|Back|-|
|Статус счета|Label|20|-|-|+|-|-|Back|<font color="green">ACTIVE</font> - Активен<br><font color="grey">CLOSED</font> - Закрыт<br><font color="orange">RESERVED</font> - Зарезервирован|

## Результат

- Клиент в личном кабинете 

---

# `POST /accounts/` Открыть Счёт

## История версий
|Задача|Тип изменения|Цвет изменения|Дата|Автор|
|-|-|-|-|-|
|-|Создано|-|28.08.2024|Внуков В.В.|

## Сервис 
**Микросервис:** account-manager

### Алгоритм вызова
- Sequence UML (вставить картинку)

Акторы:
- Пользователь
- Фронт
- Бек
- БД
- + Альтернативные сценарии

### Свойства вызова

|Свойство|Описание|
|-|-|
|Тип взаимодействия|REST/Kafka|
|Формат запроса/ответа|JSON|
|Тип вызова|Асинхронный|
|Протокол взаимодействия|MTLS|
|Способ аутентификации|JWT|

### Формат запроса

|Параметр|Тип|Длина|Расположение<br>(path/query)|Обязательность|Описание|
|-|-|-|-|-|-|
|-|-|-|-|-|-|

#### Пример
```POST /accounts/```

### Тело запроса
|Параметр|Тип|Длина|Расположение (body)|Обязательность|Описание|Место для сохранения|
|-|-|-|-|-|-|-|
|clientId|string|body|11|+|Уникальный идентификатор счета|acc.subjid|
|bals|string|body|5|+|Уникальный идентификатор счета|acc.bals|
|currency|string|body|3|+|Уникальный идентификатор счета|acc.cur|
|accountName|string|body|50|-|Уникальный идентификатор счета|acc.name|

#### Пример

```json
{
  "clientId": "0001010",
  "bals": "40817",
  "currency": "RUB",
  "accountName": "не заполнено"
}
```

### Формат ответа

|Параметр|Тип|Длина|Обязательность|Описание|Источник данных|Отображение на фронте|
|-|-|-|-|-|-|-|
|accountId|string|11|+|Уникальный идентификатор счета|acc.id|-|
|accountNumber|string|20|+|Номер счета|acc.number|Номер счета|
|balance|number($double)|15,2|+|Текущий баланс счета|acc.saldo|Баланс счета|
|status<br>|string|20|+|Статус счета<br>Enum:[ACTIVE, CLOSED, RESERVED, DELETED]|acc.status|Статус|

#### Пример

```json
{
  "accountId": "00000001234",
  "accountName": "не заполнено",
  "clientId": "0001010",
  "clientName": "Иванов Петр Сидорович",
  "bals": "40817",
  "currency": "RUB",
  "accountNumber": "40817810300000000003",
  "accountType": "П",
  "status": "ACTIVE",
  "balance": 0.01,
  "timeStamp": "2024-08-28T02:37:13.568Z"
}
```

## Коды ответов

|Код|Название|Описание|Поведение системы|
|-|-|-|-|
|200|OK|Запрос обработан|Продолжить процесс|
|400|Bad Request| Некорректный счет|Отобразить ошибку|
|403|Forbidden| Доступ запрещен|Отобразить ошибку|
|404|Not Found| Счет не найден|Отобразить ошибку|
|500|Internal Server Error|Внутренняя ошибка сервера|Отобразить ошибку|

## Алгоритм обработки запроса

1. **Back** при получении запроса, обращается в таблицу `user`, находит список счетов и проводит валидацию на совпадение.
   - (Приложить пример SQL запроса)
2. **Back** по запрошенному счету, обращается в таблицу `account_info` и отдает ответ на **Front** в соответствии с п. [Формат ответа](#формат-ответа).

## Альтернативные процессы

- Ошибки 4xx, 5xx:
  - **Back** возвращает ошибку с текстом на **Front** в соответствии с п. [Коды ответов](#коды-ответов).
